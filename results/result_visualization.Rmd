---
title: "Result visualization"
#output: html_notebook
---
This notebook is used for visualizing the results from V-phaser2 and the Shannon entropies that are generated by using the project pipeline in script project_script.Rmd. 

# Loading data


###################################### SHANNON ENTROPY #####################################
########################Mean Shannon Entropy with standard error of the mean################
```{r}
path_to_shannon_files = "~student12/project/results/shannon_entropy/"

library(tidyverse)

# List the data
file_list = list.files(path_to_shannon_files, pattern = "shannon_" ,full.names = TRUE)

column_names = c()
shannon_entropies = data.frame()

# Load the data in the folder
for (file in file_list){
  
  column_names = cbind(column_names, tools::file_path_sans_ext(basename(file)))
  shannon_entropies = rbind(shannon_entropies, t(read.table(file)))
  
}

# Needing to transpose data and rename columns
shannon_entropies = as.data.frame(t(as.matrix(shannon_entropies)))
colnames(shannon_entropies) = column_names

```
```{r}
# Calculate standard error of the mean
standard_error = function(x) sd(x) / sqrt(length(x))

# Calculate mean entropy and standard error of the mean
mean_entropies = sapply(shannon_entropies, mean)
se = sapply(shannon_entropies, standard_error)
x = 0:5
```

```{r}
# plot the means and se
par(mfrow = c(1,2), fig=c(0.1,0.7,0.3,0.9)) 
plot(x, mean_entropies[1:6],
    ylim=range(c(mean_entropies[1:6]-se[1:6], mean_entropies[1:6]+se[1:6])),
    pch=19, xlab="Passage", ylab="Mean Shannon entropy +/- SD",
    main="Mean entropy in 3'UTRΔ10 ZIKV passage 0-5")
arrows(x, mean_entropies[1:6]-se[1:6], x, mean_entropies[1:6]+se[1:6], length=0.05, angle=90, code=3)
plot(x, mean_entropies[7:12],
    ylim=range(c(mean_entropies[7:12]-se[7:12], mean_entropies[7:12]+se[7:12])),
    pch=19, xlab="Passage", ylab="Mean Shannon entropy +/- SD",
    main="Mean entropy in WT ZIKV passage 0-5")
arrows(x, mean_entropies[7:12]-se[7:12], x, mean_entropies[7:12]+se[7:12], length=0.05, angle=90, code=3)

```
###################################### SHANNON ENTROPY #####################################
########################Mean Shannon Entropy and Coverage###################################
```{r}

path_to_SNP_files = "~student12/project/results/SNP/"

# List the data
cov_file_list = list.files(path_to_SNP_files, pattern = "covplot.R" ,full.names = TRUE)

column_names = c()
coverage = data.frame()

# Load the data in the folder
for (file in cov_file_list){
  
  column_names = cbind(column_names, tools::file_path_sans_ext(basename(file)))
  # Read the file
  source(file)
  # variable y is the vector containing the coverage in the file
  coverage = rbind(coverage, y)
  
}

# Needing to transpose data and rename columns
coverage = as.data.frame(t(as.matrix(coverage)))
colnames(coverage) = column_names
# Find mean coverage and se
mean_coverage = sapply(coverage, mean)
se_cov = sapply(coverage, standard_error)
# Combine the mean coverage and mean entropies for convenience
cov_shannon = as.data.frame(cbind(mean_coverage, mean_entropies))

# Replace the rownames with only the strain and passage
row_names = str_replace(rownames(cov_shannon), "SNP_","") %>% str_replace(".covplot","")
rownames(cov_shannon) = row_names


```
```{r}
#create a new variable that contain either WT or 10
strain <-substr(row_names,1,2)
#we add thoses values to the data frame, to identify the samples
cov_ready_to_plot <- cbind(cov_shannon,strain)

ggplot(cov_ready_to_plot, aes(x=mean_coverage,y=mean_entropies))+
  geom_point(aes(shape=strain))+
  geom_smooth(method = "lm", se = FALSE)+
  theme(legend.position = "right")+
  labs(x="Coverage Depth",y="Shannon Entropy")

```
###################################### SNV #####################################
########################SNV Frequencies according the the passages##############

```{bash}

### Processing WT files to remove the two first lines and extract only the information we need (position in the genome and frequency of the mutation in the viral population)
  grep -v "#" SNP_WT_P0.fdr.var.txt | cut -f 1,6  > modified_SNP_WT_P0.fdr.var.txt
  grep -v "#" SNP_WT_P1.fdr.var.txt | cut -f 1,6  > modified_SNP_WT_P1.fdr.var.txt
  grep -v "#" SNP_WT_P2.fdr.var.txt |cut -f 1,6> modified_SNP_WT_P2.fdr.var.txt
  grep -v "#" SNP_WT_P3.fdr.var.txt |cut -f 1,6> modified_SNP_WT_P3.fdr.var.txt
  grep -v "#" SNP_WT_P4.fdr.var.txt |cut -f 1,6> modified_SNP_WT_P4.fdr.var.txt
  grep -v "#" SNP_WT_P5.fdr.var.txt |cut -f 1,6> modified_SNP_WT_P5.fdr.var.txt
  
  
### Processing 10_D files to remove the two first lines and extract only the information we need (position in the genome and frequency of the mutation in the viral population)
  grep -v "#" SNP_10D_P0.fdr.var.txt | cut -f 1,6  > modified_SNP_10D_P0.fdr.var.txt
  grep -v "#" SNP_10D_P1.fdr.var.txt | cut -f 1,6  > modified_SNP_10D_P1.fdr.var.txt
  grep -v "#" SNP_10D_P2.fdr.var.txt |cut -f 1,6 > modified_SNP_10D_P2.fdr.var.txt
  grep -v "#" SNP_10D_P3.fdr.var.txt |cut -f 1,6 > modified_SNP_10D_P3.fdr.var.txt
  grep -v "#" SNP_10D_P4.fdr.var.txt |cut -f 1,6 > modified_SNP_10D_P4.fdr.var.txt
  grep -v "#" SNP_10D_P5.fdr.var.txt |cut -f 1,6 > modified_SNP_10D_P5.fdr.var.txt
```

```{r}
library(tidyverse)

##First we need to obtain under the format of data.frame all the SNVs for each passage for each strain.
#To do that we determinate and list the files of interest using list.files.

path_to_SNP_files ="/home/student12/project/results/SNP"
all_files_WT = list.files(path_to_SNP_files, pattern ="modified_SNP_WT", full.names = TRUE)
all_files_10D = list.files(path_to_SNP_files, pattern ="modified_SNP_10D", full.names = TRUE)

#Then we import every files per strain under the dataframe format :

all_data_frames_WT <- lapply(all_files_WT, function(x){
  read.csv(x,header = FALSE, sep="\t") } )
all_data_frames_10D <- lapply(all_files_10D, function(x){
  read.csv(x,header = FALSE, sep="\t") } )

#We then modify the name of the columns to clearly identify position and frequency, then we create a new column containing the number of the passage for each SNV. This will help us later to plot every SNVs by group.

for (i in 1:6) {
  colnames(all_data_frames_WT[[i]]) <- c("Position","Frequency")
  all_data_frames_WT[[i]] <- mutate(all_data_frames_WT[[i]], Passage = i-1)
  all_data_frames_WT[[i]] <- mutate(all_data_frames_WT[[i]],Strain = "WT")
}
for (i in 1:6) {
  colnames(all_data_frames_10D[[i]]) <- c("Position","Frequency")
  all_data_frames_10D[[i]] <- mutate(all_data_frames_10D[[i]], Passage = i-1)
  all_data_frames_10D[[i]] <- mutate(all_data_frames_10D[[i]],Strain = "10D")
}

#We can now group our data frames to work with only one 
single_data_frame <- Reduce(rbind, c(all_data_frames_WT,all_data_frames_10D))
single_data_frame$Passage <- as.factor(single_data_frame$Passage)
```
```{r}
#Then we can finally plot the figures we wanted to obtain. 
library(tidyverse)
par(mfrow = c(1,2), fig=c(0.1,0.7,0.3,0.9)) 
single_data_frame %>%
  filter(Strain =="WT")%>%
  ggplot(aes(x = Passage, y= Frequency)) + 
  geom_boxplot() + 
  geom_point(position = "jitter") +
  theme_minimal() +
  labs(x = "Passage", y = "SNV Frequency (%)", title = "WT")
single_data_frame %>%
  filter(Strain =="10D")%>%
  ggplot(aes(x = Passage, y= Frequency)) + 
  geom_boxplot() + 
  geom_point(position = "jitter") +
  theme_minimal() +
  labs(x = "Passage", y = "SNV Frequency (%)", title ="3'UTRΔ10")
  
# we can add scale_y_continuous(name = "SNV Frequency (%)", limits = c(0, 30)) to improve the visibility of the graphs
#command to save the graphs : ggsave("plot.png", width = 5, height = 5) Saves last plot
#as 5’ x 5’ file named "plot.png" in working directory.
#Matches file type to file extension
```
##################################SNP#####################################################
#####################Mapping Mutations in the Genome######################################

#We now can identify and plot on the map of the genome the mutations that appears in one or multiple passages at a frequency of 5% or more in the viral population. Those mutations are really interesting because they are the consequence of the adaptation of the viruses to the host.

```{r}
#we first filter the data frame containing all the information we need, and arrange the data frame according the position of the SNV in the genome. We remove the duplicates tricplicates or more with the command distinct. We can then sort everything by the Strain and plot the position of the SNVs in the genome.

mutation_of_interest <- filter(single_data_frame, Frequency >= 5) %>%
  arrange(desc(Position)) %>%
  distinct(Position, .keep_all = TRUE) %>%
  arrange(Strain)

ggplot(mutation_of_interest, aes(x=Position, y = 1, color=Strain))+
  geom_point()

#find a way to map the position axis 
```

############################SNP#############################################################
#################Total SNPs -> Mean coverage################################################

```{r}

# Here we want to show if there is a correlation between the coverage depth and the total amount of SNV. The idea is to determinate if the coverage depth is related to the total amount of SNVs which could help us to determine whether or not the coverage depth can be optimize for SNV detection.
#We start by counting the total amount of SNV per passage per strain. We can then add the mean_coverage list to the dataframe obtained and plot the result.

library(tidyverse)
total_ammount_SNV = count(single_data_frame,Passage,Strain)
SNV_frequency_and_coverage <- cbind(total_ammount_SNV,mean_coverage)

ggplot(SNV_frequency_and_coverage, aes(x=mean_coverage,y=n))+
  geom_point(aes(shape=strain))+
  geom_smooth(method = "lm", se = FALSE)+
  theme(legend.position = "right")+
  labs(x="Coverage Depth",y="Total of SNVs")
```



#########################SNP################################################################
#########Mean SNP frequency -> Mean coverage ###############################################






